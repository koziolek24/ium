<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI AJAX Test</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 600px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        input:focus {
            border-color: #007bff;
            outline: none;
        }
    </style>
</head>

<body>
    <h1>IUM model</h1>
    <form id="prediction-form">
        <div class="form-group">
            <label for="field1">neighbourhood</label>
            <input type="text" id="field1" name="field1">
        </div>

        <div class="form-group">
            <label for="neighbourhood_cleansed">neighbourhood_cleansed</label>
            <input type="text" id="neighbourhood_cleansed" name="neighbourhood_cleansed">
        </div>

        <div class="form-group">
            <label for="property_type">property_type</label>
            <input type="text" id="property_type" name="property_type">
        </div>

        <div class="form-group">
            <label for="accommodates">accommodates</label>
            <input type="text" id="accommodates" name="accommodates">
        </div>

        <div class="form-group">
            <label for="bathrooms">bathrooms</label>
            <input type="text" id="bathrooms" name="bathrooms">
        </div>

        <div class="form-group">
            <label for="bedrooms">bedrooms</label>
            <input type="text" id="bedrooms" name="bedrooms">
        </div>

        <div class="form-group">
            <label for="beds">beds</label>
            <input type="text" id="beds" name="beds">
        </div>

        <div class="form-group">
            <label for="room_type">room_type</label>
            <input type="text" id="room_type" name="room_type">
        </div>

        <button type="button" id="submit-btn"
            style="width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
            Done (Submit)
        </button>
        <p id="timer-display" style="text-align: center; color: #666; margin-top: 10px;"></p>

        
    </form>

    <script>
        const form = document.getElementById('prediction-form');
        let startTime = null;
        let isFinished = false;

        // Listen for changes on the entire form (event delegation)
        form.addEventListener('input', async (event) => {
            if (isFinished) return;

            // 1. Start Timer on first interaction
            if (!startTime) {
                startTime = Date.now();
                console.log("Timer started!");
            }

            // Only trigger if an input field changed
            if (event.target.tagName !== 'INPUT') return;

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                // Send current form state to backend
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    const predictions = await response.json();

                    // Update fields with values from response
                    // avoiding the field getting focused to not interrupt typing
                    Object.entries(predictions).forEach(([key, value]) => {
                        // Skip metadata
                        if (key.startsWith('_')) return;

                        const input = form.elements[key];
                        if (input && input !== document.activeElement && value) {
                            input.value = value;
                        }
                    });
                }
            } catch (error) {
                console.error('Error fetching prediction:', error);
            }
        });

        // 2. Stop Timer on Submit
        document.getElementById('submit-btn').addEventListener('click', async () => {
            if (!startTime) {
                alert("You haven't typed anything yet!");
                return;
            }

            const endTime = Date.now();
            const durationMs = endTime - startTime;
            const durationSec = (durationMs / 1000).toFixed(2);

            isFinished = true;
            document.getElementById('timer-display').innerText = `Time taken: ${durationSec} seconds`;

            // Send metric to backend
            await fetch('/submit_time', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ duration_seconds: parseFloat(durationSec) })
            });

            alert(`Great! You finished in ${durationSec} seconds.`);

            // Optional: Reset for next test
            // location.reload(); 
        });
    </script>
</body>

</html>